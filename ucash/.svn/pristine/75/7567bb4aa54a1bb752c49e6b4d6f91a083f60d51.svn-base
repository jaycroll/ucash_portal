$(document).ready( function(){

	var z_index = 0;
	var additem_click = 0;
	var file = "a";	
	var div_id = 0;
	var tinymce_plugins = [
		    'advlist autolink lists link image charmap print preview anchor',
		    'searchreplace visualblocks code fullscreen',
		    'insertdatetime media table contextmenu paste',
		    'colorpicker emoticons spellchecker textcolor'
		  ];
	var tinymce_toolbar = 'insertfile undo redo | styleselect | bold italic | fontselect | fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image';
	var tinymce_fontsize = "8pt 10pt 12pt 14pt 18pt 24pt 36pt";
	tinymce.init({
	  selector: 'div.editable',
	  inline: true,
	  plugins: tinymce_plugins,
	  toolbar: tinymce_toolbar
	});
	if(!$("#content").is(':empty')){
		$('#content').children().each(function () {
		    $(this).off('mousedown').mousedown(function(event){
	   			switch(event.which){
	   				case 2: 
	   					event.preventDefault();
	   					x = event.pageX;
	   					y = event.pageY;
	   					 $(this).openMenu({x: x, y: y}).modifyCssElement();
	   					break;
	   			}
	   		});
	   		$(this).off('dblclick').on("dblclick",function(event){
	   			event.preventDefault();
	   			$(this).transformElement();

	   		});

		});

	}
	$( "#settings" ).click( function(){
		$(this).hide();
		$( "#dheader" ).show();
	});
	$( "#close_settings" ).click( function(){
		$( "#dheader" ).hide();
		$( "#settings" ).show();
	});
	$( "#additem" ).click( function(){
		if( additem_click == 0 ){
			$( "#menu1" ).show();
			additem_click = 1;
		} else{
			$( "#menu1" ).hide();
			additem_click = 0;
		}
	});

	$( "#menu1 li a" ).click( function(){
		$("#menu1").hide();
		additem_click = 0;
	});

	$( "#addimage" ).click( function(){
		$("#imgDrop").show();
	});
	$(document).focusout( function(){
		$(this).hide();
		$('#contextmenu').hide();
	});
	$( "#addrectangle" ).click( function(){
		// console.log(z_index);
		testcase = 0;
		
		while($('#div_'+div_id).length != 0){
			if($('#div_'+div_id).length==0){
				console.log('getshere');
				break;
			}
			div_id++;
		}
		$("#content").append("<div class='draggable rect' id='div_"+div_id+"'></div>");
		var created_element = $("#div_"+div_id);
		created_element.css("border","1px solid");
		created_element.css("height","120px");
		created_element.css("width","120px");
		created_element.css("float","left");
		created_element.css("word-wrap","break-word");
		created_element.addClass("editable");
		
		interactElement(created_element);
		tinymce.init({
		  selector: 'div.editable',
		  inline: true,
		  plugins: tinymce_plugins,
		  toolbar: tinymce_toolbar
		});
		div_id++;
		z_index++;

	});
	$( "#addcircle" ).click( function(){
		while($('#div_'+div_id).length != 0){
			if($('#div_'+div_id).length==0){
				console.log('getshere');
				break;
			}
			div_id++;
		}
		$("#content").append("<div class='draggable circle' id='div_"+div_id+"'></div>");
		var created_element = $("#div_"+div_id);
		created_element.css("border","1px solid");
		created_element.css("height","120px");
		created_element.css("width","120px");
		created_element.css("border-radius","50%");
		created_element.css("behavior","url(PIE.htc)");
		created_element.css("word-wrap","break-word");
		created_element.addClass("editable");
		interactElement(created_element);
		tinymce.init({
		  selector: 'div.editable',
		  inline: true,
		  plugins: tinymce_plugins,
		  toolbar: tinymce_toolbar
		});
		div_id++;
		z_index++;

	});
   var $dropzone = $("#imgDrop").dropzone({
   		paramName: "file",
   		url: "/home/img_upload",
   		addedfile: function(file) {
			//do nothing :D
		},
		success: function(file) {		
			$("#imgDrop").hide();
			var args = Array.prototype.slice.call(arguments);
			
			fileDetails = JSON.parse(args[1]);
			filename = fileDetails.filename.split(".")[0];
			var this_element = $("#"+filename);
			$("#content").append("<img class='draggable img' id='"+filename+"'src='"+uploadUrl+fileDetails.filename+"'/>");
			$("#"+filename).css("height",fileDetails.height);
			$("#"+filename).css("width",fileDetails.width);
			interactElement(this_element);
		}
   });
   function interactElement(element){
   		element.off('mousedown').mousedown(function(event){
   			switch(event.which){
   				case 2: 
   					event.preventDefault();
   					event.preventDefault();
					x = event.pageX;
					y = event.pageY;
   					$( this ).openMenu({x: x, y: y}).modifyCssElement();
   					element = "";
   					break;
   				case 1:
   					
			    break;
   			}
   		});
   		element.off('dblclick').on("dblclick",function(event){
   			event.preventDefault();
  			$( this ).transformElement();
   		});
   }

   function dragMoveListener (event) {
   	$(event.target).css("position","absolute");
   	$(event.target).css("margin","0");
    var target = event.target,
        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
    var height = parseInt($("#content").css("min-height").split("px")[0])+10;
    $("#content").css("height",height+"px");
    var tHeight = parseInt($(event.target).css("height").split("px")[0]);
	var eHeight = parseInt($("#content").css("min-height").split("px")[0]);
	if($(event.target).css('padding').length){
		var padding = $(event.target).css('padding').split('px');
		var margin = $(event.target).css('margin').split('px');
		var border = $(event.target).css('border').split('px');
		if(padding[2] != undefined){
			tHeight = tHeight + parseInt(padding[2]) + 10;
		} else{
			tHeight = tHeight + parseInt(padding[0])  + 10;
		}

		if(border[2] != undefined){
			tHeight = tHeight + parseInt(border[2]);
		} else{
			tHeight = tHeight + parseInt(border[0]);
		}
		if(margin[2] != undefined){
			tHeight = tHeight + parseInt(margin[2]);
		} else{
			tHeight = tHeight + parseInt(margin[0]);
		}
	}
    if( (eHeight - 1) <= (Math.ceil(y)+ tHeight)){
    	var additionalHeight = 10;
    	$("#content").css("min-height",eHeight+additionalHeight);


    }
    target.style.webkitTransform =
    target.style.transform =
      'translate(' + Math.ceil(x) + 'px, ' + Math.ceil(y) + 'px)';
    $(event.target).css("top",y+" !important");
    $(event.target).css("left",x+" !important");
    $(event.target).css("position","absolute");
    $("#position_container").show();
    $("#position_container").css("background","#444");
    $("#position_container").css("color","#fff");
    $("#position_container").css("max-width","200px");
    $("#position_container").css( 'position', 'absolute' );
    $("#position_container").css( 'top', event.dy+Math.ceil(y)-20);
    if(event.dy+y-20 <=10){
    	$("#position_container").css( 'top', target.style.height);
    }
    
	$("#position_container").css( 'left', event.dx+Math.ceil(x)+20 );
	$("#position_container").css( 'z-index', 99999 );
	$("#position_container").text( "left: "+Math.ceil(x)+" top:"+Math.ceil(y) );
    target.setAttribute('data-x', x);
    target.setAttribute('data-y', y);
  }

  window.dragMoveListener = dragMoveListener;
  window.setInterval(function(){
  		savePage();
	}, 60000);

  $("#save").click( function(){
  		savePage();
  });
  function savePage(){
  		var elements = $("section").html().trim();
  		var args  = {
  			content : elements
  		};
  		$.post(homeUrl+"home/savepage/",args, function(data){
  			console.log("saved");
  		});

  }
});


(function ( $ ){

	$.fn.transformElement = function(opt) {
		var element  = this;
		var perserveAspectRatio = false;
   		var size_container = $("#size_container");
   		var position_container = $( "#position_container" );
   		var old_border = element.css("border");

   		if(element.hasClass("img")){
   			perserveAspectRatio = true;
   		} 

   		if(element.hasClass("circle")){
   			perserveAspectRatio = true;
   		}

   		var parentVar = "#content";
		interact(document.getElementById(element.attr('id')))
		  .draggable({
		  	snap: {
		      targets: [
		        interact.createSnapGrid({ x: 10, y: 10 })
		      ],
		      range: Infinity,
		      relativePoints: [ { x: 0, y: 0 } ]
		    },
		    restrict: {
		      restriction: parentVar,
		      endOnly: false,
		      elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
		    },
		    onmove: function(event) {
		    	
		    	dragMoveListener(event);

		    },
		    onend: function (event) {

		      var xpos = Math.ceil(event.target.getAttribute("data-x"));
		      var ypos = Math.ceil(event.target.getAttribute("data-y"));
		      $(event.target).css("border",old_border);
		      $(event.target).removeClass("draggable");
		      $(event.target).css("position","absolute");
		      $(event.target).css("transform","");
		      $(event.target).css("margin", ypos+"px 0 0 "+xpos+"px");
		      
		      position_container.empty();
		      position_container.hide();
		      interact(document.getElementById(element.attr('id'))).draggable(false);
		    }
		  }).resizable({
		    preserveAspectRatio: perserveAspectRatio,
		    edges: { left: false, right: true, bottom: true, top: false }
		  }).on('resizemove', function (event) {
		  	$(event.target).css("position","absolute");
   			$(event.target).css("margin","0");
   			var tHeight = parseInt($(event.target).css("height").split("px")[0]);
			var eHeight = parseInt($("#content").css("min-height").split("px")[0]);
		    if( (eHeight - 1) <= (Math.ceil(y)+ tHeight)){
		    	$("#content").css("min-height",tHeight + eHeight);
		    }
		    var target = event.target,
		        x = (parseFloat(target.getAttribute('data-x')) || 0),
		        y = (parseFloat(target.getAttribute('data-y')) || 0);
		    target.style.width  = event.rect.width + 'px';
		    target.style.height = event.rect.height + 'px';
		    x += event.deltaRect.left;
		    y += event.deltaRect.top;

		    target.style.webkitTransform = target.style.transform =
		        'translate(' + Math.ceil(x) + 'px,' + Math.ceil(y) + 'px)';

		    target.setAttribute('data-x', x);
		    target.setAttribute('data-y', y);
		    
		    size_container.show();
		    size_container.css("background","#444");
		    size_container.css("color","#fff");
		    size_container.css("max-width","100px");
		    size_container.css( 'position', 'absolute' );
		    size_container.css( 'top', event.rect.height+y );
	    	size_container.css( 'left', event.rect.width+x );
	    	size_container.css( 'z-index', 99999 );
		    size_container.text(Math.round(event.rect.width) + " x " + Math.round(event.rect.height));
		  }).on('resizeend', function(event){
		  	size_container.empty();
		  	size_container.hide();
		  	$(event.target).removeClass("draggable");
		  	interact(document.getElementById(element.attr('id'))).resizable(false);
   		  	

		  });
		return this;
	}

}( jQuery ));

(function ( $ ) {
 
    $.fn.openMenu = function(opt) {
    	var element = this;
    	var contextmenu = $("#contextmenu");
        contextmenu.on("contextmenu", function(){
   			});
        console.log(x+" "+y);
        
   		contextmenu.css( 'position', 'absolute' );
	    contextmenu.css( 'top', y );
	    contextmenu.css( 'left', x );
	    contextmenu.show();
	    contextmenu.on("click", function(){
	    		
   				contextmenu.hide();
   			});
	    $("#addContent").off('click').on("click", function(){
        		contextmenu.hide();

	    });
	    $('#deleteElement').off('click').on("click", function(){
	    	element.remove();
	    	contextmenu.hide();

	    });
	    $('#close_context').off('click').on("click", function(){
	    	contextmenu.hide();

	    });
        return this;
    };
 
}( jQuery ));
(function ( $ ) {
 
    $.fn.modifyCssElement = function() {
    	var element = this;
    	console.log(this.attr('id'));
        $('#border').val(element.css("border"));
	    $('#padding').val(element.css("padding"));
	    $('#z-index').val(element.css("z-index"));
	    $('#border-radius').val(element.css("border-radius"));
	    
	    
	    var elembg = this.css('background');
   		$("#padding").focusout( function(){
			element.css('padding', "");
			element.css('padding', $(this).val());

		});

		$("#border-radius").off('focusout').focusout( function(){
			element.css('-webkit-border-radius', "");
			element.css('-moz-border-radius', "");
			element.css('border-radius', "");
			element.css('-webkit-border-radius', $(this).val());
			element.css('-moz-border-radius', $(this).val());
			element.css('-moz-border-radius', $(this).val());
			

		});
		$("#border").off('focusout').focusout( function(){
			element.css('border', "");
			element.css('border', $(this).val());
			console.log(element.attr('id'));

		});
		$("#z-index").off('focusout').focusout( function(){
			element.css('z-index', "");
			element.css('z-index', $(this).val());

		});
		
   		$("#bg").spectrum({
		    showAlpha: true,
		    color : "#"+elembg,
		    preferredFormat: "rgb",
		    showInput: true,
		    showPalette: true,
		    showButtons: false,
		    palette: [["red", "rgba(0, 255, 0, .5)", "rgb(0, 0, 255)"]],
		    change: function( color ){
   				element.css('background', color );
		    }
		});
		$('#contextmenu').unbind();

        return this;
    };
 
}( jQuery ));